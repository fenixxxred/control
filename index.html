<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loja — Produtos, Clientes e Vendas (Local)</title>
<style>
  :root{--bg:#fac2c2;--accent:#b30000;--dark:#160202;--card:#fff}
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Arial,Helvetica,sans-serif}
  body{min-height:100vh;background:var(--bg);color:var(--dark);display:flex;gap:18px;padding:18px}
  .sidebar{width:220px;background:var(--dark);color:#fff;border-radius:10px;padding:14px;flex-shrink:0}
  .logo{background:var(--accent);padding:12px;border-radius:8px;text-align:center;font-weight:700;margin-bottom:10px}
  .nav{list-style:none;margin-top:8px}
  .nav li{padding:10px;border-radius:6px;cursor:pointer}
  .nav li:hover,.nav li.active{background:rgba(179,0,0,0.12);color:var(--accent)}
  .main{flex:1}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:8px;flex-wrap:wrap}
  .header h1{font-size:1.2rem;color:var(--dark);margin-left:8px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
  .search{padding:8px 10px;border-radius:8px;border:1px solid #ccc;width:220px}
  .stats{display:flex;gap:8px;align-items:center}
  .card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:12px}
  .product-card{background:var(--card);border-radius:10px;padding:12px;border:1px solid rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:8px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
  .product-card img{width:100%;height:160px;object-fit:cover;border-radius:8px;background:#f6f6f6}
  .product-card h3{font-size:1rem;color:var(--accent);margin-top:4px}
  .product-card p{font-size:.95rem;color:var(--dark)}
  .product-meta{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
  .meta-left{display:flex;flex-direction:column}
  .meta-right{display:flex;gap:8px}
  .small{font-size:.85rem;color:#666}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:999;display:none}
  .modal.open{display:flex}
  .modal-content{background:#fff;border-radius:10px;padding:16px;width:min(920px,96%);max-height:90vh;overflow:auto}
  label{display:block;font-weight:600;color:var(--accent);margin-bottom:6px}
  input[type=text], input[type=number], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  .img-preview{max-width:160px;max-height:160px;border-radius:8px;object-fit:cover;border:1px solid #eee}
  table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden}
  thead th{background:var(--accent);color:#fff;text-align:left;padding:10px;font-weight:700}
  tbody td{padding:10px;border-bottom:1px solid #eee}
  @media(max-width:880px){ .grid-3{grid-template-columns:1fr} .sidebar{display:none} body{padding:12px} }
</style>
</head>
<body>

  <aside class="sidebar">
    <div class="logo">Controle • Estoque</div>
    <ul class="nav">
      <li class="active" data-page="dashboard">Dashboard</li>
      <li data-page="produtos">Produtos</li>
      <li data-page="clientes">Clientes</li>
      <li data-page="vendas">Vendas</li>
      <li data-page="backup">Backup</li>
    </ul>
  </aside>

  <main class="main">
    <div class="header">
      <h1 id="titulo">Dashboard</h1>
      <div class="controls">
        <input class="search" id="q" placeholder="Buscar...">
        <div class="stats small" id="stats">—</div>
        <button class="btn" id="btn-novo" style="display:none">Novo</button>
        <button class="btn ghost" id="btn-export">Exportar JSON</button>
      </div>
    </div>

    <div id="view"></div>
  </main>

  <!-- Modal Produto -->
  <div id="modalProduto" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h2 id="modal-prod-title">Novo Produto</h2>
      <div style="margin-top:8px">
        <div class="grid-3">
          <div>
            <label>Nome</label><input type="text" id="p-nome" placeholder="Nome do produto">
          </div>
          <div>
            <label>Categoria</label>
            <select id="p-cat">
              <option value="">— Selecione a categoria —</option>
              <option value="Lubrificantes">Lubrificantes</option>
              <option value="Vibradores">Vibradores</option>
              <option value="Cosméticos">Cosméticos</option>
              <option value="Acessórios">Acessórios</option>
              <option value="Roupas">Roupas</option>
              <option value="Brinquedos Eróticos">Brinquedos Eróticos</option>
            </select>
          </div>

          <div>
            <label>Quantidade</label><input type="number" id="p-qtd" value="1" min="0">
          </div>
        </div>

        <div class="grid-3" style="margin-top:8px">
          <div>
            <label>Preço (R$)</label><input type="number" id="p-preco" step="0.01" value="0">
          </div>
          <div>
            <label>Fornecedor</label><input type="text" id="p-forn" placeholder="Fornecedor">
          </div>
          <div>
            <label>SKU (opcional)</label><input type="text" id="p-sku" placeholder="p001">
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1">
            <label>Imagem</label><input type="file" id="p-img" accept="image/*">
            <div style="margin-top:8px"><small class="small">A imagem será salva localmente (base64).</small></div>
          </div>
          <div style="width:170px">
            <img id="p-prev" class="img-preview" style="display:none" alt="Prévia">
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="p-salvar">Salvar</button>
          <button class="btn ghost" id="p-cancel">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Cliente -->
  <div id="modalCliente" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h2 id="modal-cli-title">Novo Cliente</h2>
      <div style="margin-top:8px">
        <div class="grid-2">
          <div>
            <label>Nome</label><input type="text" id="c-nome">
          </div>
          <div>
            <label>Telefone</label><input type="text" id="c-tel">
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Endereço</label><input type="text" id="c-end">
        </div>
        <div class="actions">
          <button class="btn" id="c-salvar">Salvar</button>
          <button class="btn ghost" id="c-cancel">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Venda -->
  <div id="modalVenda" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h2>Registrar Venda</h2>
      <div style="margin-top:8px">
        <div class="grid-3">
          <div>
            <label>Cliente</label>
            <select id="v-cliente"><option value="">— Cliente (opcional) —</option></select>
          </div>
          <div>
            <label>Pagamento</label>
            <select id="v-pagamento"><option>Dinheiro</option><option>Cartão crédito</option><option>Cartão débito</option><option>Pix</option></select>
          </div>
          <div>
            <label>Desconto (R$)</label><input type="number" id="v-desconto" step="0.01" value="0">
          </div>
        </div>

        <div style="margin-top:10px">
          <h3>Adicionar item</h3>
          <div class="grid-3">
            <div>
              <label>Produto</label>
              <select id="v-produto"></select>
            </div>
            <div>
              <label>Quantidade</label><input type="number" id="v-qtd" value="1" min="1">
            </div>
            <div style="display:flex;align-items:end"><button class="btn" id="v-add-item">Adicionar ao carrinho</button></div>
          </div>

          <div style="margin-top:12px">
            <h3>Itens</h3>
            <table id="v-itens-table"><thead><tr><th>Produto</th><th>Qtd</th><th>Preço</th><th>Total</th><th>Ações</th></tr></thead><tbody></tbody></table>
            <p style="text-align:right;font-weight:700" id="v-total">Total: R$ 0,00</p>
          </div>

          <div class="actions" style="margin-top:8px">
            <button class="btn" id="v-confirmar">Confirmar Venda</button>
            <button class="btn ghost" id="v-cancel">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== UTILITÁRIOS ===== */
const LS = {
  get(k, def){ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; }catch{ return def; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
};
const uid = ()=> Math.random().toString(36).slice(2,9) + Date.now().toString(36).slice(-4);
const fmtBRL = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

/* ===== SEED DE PRODUTOS (IMAGENS EMBUTIDAS COMO SVG DATAURL PARA PORTABILIDADE) ===== */
const sampleImg = (text, color='#b30000') => {
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='${color}'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='48' fill='#fff' font-family='Arial,Helvetica,sans-serif'>${text}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
};
const seedProducts = [
  { id:'p1', nome:'Gel Excitante Unissex Dragao 15ml', categoria:'Lubrificantes', qtd:10, preco:30.00, fornecedor:'Loja Online', sku:'LUB-001', img:'img/red_p1.webp' },
  { id:'p2', nome:'Gel Corporal Hot Ball Menta 2un', categoria:'Lubrificantes', qtd:10, preco:20.00, fornecedor:'Loja Online', sku:'LUB-002', img:'img/red_p2.webp' },
  { id:'p3', nome:'Lubrificante Íntimo Neutro 50ml', categoria:'Lubrificantes', qtd:10, preco:25.00, fornecedor:'Loja Online', sku:'LUB-003', img:'img/red_p3.webp' },
  { id:'p4', nome:'Gel Beijável Morango 15ml', categoria:'Lubrificantes', qtd:10, preco:15.00, fornecedor:'Loja Online', sku:'LUB-004', img:'img/red_p4.webp' },
  { id:'p5', nome:'Lubrificante Íntimo Hot Ice 60ml', categoria:'Lubrificantes', qtd:10, preco:28.00, fornecedor:'Loja Online', sku:'LUB-005', img:'img/red_p5.webp' },
  { id:'p6', nome:'Gel Excitante Beijável Uva 15ml', categoria:'Lubrificantes', qtd:10, preco:18.00, fornecedor:'Loja Online', sku:'LUB-006', img:'img/red_p6.webp' },
  { id:'p7', nome:'Lubrificante Corporal Neutro 100ml', categoria:'Lubrificantes', qtd:10, preco:35.00, fornecedor:'Loja Online', sku:'LUB-007', img:'img/red_p7.webp' },
  { id:'p8', nome:'Gel Vibrador Soft Touch 15ml', categoria:'Lubrificantes', qtd:10, preco:30.00, fornecedor:'Loja Online', sku:'LUB-008', img:'img/red_p8.webp' },
  { id:'p9', nome:'Gel Refrescante Ice Menta 15ml', categoria:'Lubrificantes', qtd:10, preco:20.00, fornecedor:'Loja Online', sku:'LUB-009', img:'img/red_p9.webp' },
  { id:'p10', nome:'Gel de Massagem Beijável Chocolate 30ml', categoria:'Lubrificantes', qtd:10, preco:22.00, fornecedor:'Loja Online', sku:'LUB-010', img:'img/red_p10.webp' },
  { id:'p11', nome:'Lubrificante Beijável Cereja 60ml', categoria:'Lubrificantes', qtd:10, preco:27.00, fornecedor:'Loja Online', sku:'LUB-011', img:'img/red_p11.webp' },
  { id:'p12', nome:'Gel Vaginal Adstringente 15ml', categoria:'Lubrificantes', qtd:10, preco:30.00, fornecedor:'Loja Online', sku:'LUB-012', img:'img/red_p12.webp' },
  { id:'p13', nome:'Gel Excitante Masculino Cowboy 15ml', categoria:'Lubrificantes', qtd:10, preco:28.00, fornecedor:'Loja Online', sku:'LUB-013', img:'img/red_p13.webp' },
  { id:'p14', nome:'Lubrificante Anal Relaxante 15ml', categoria:'Lubrificantes', qtd:10, preco:35.00, fornecedor:'Loja Online', sku:'LUB-014', img:'img/red_p14.webp' },
  { id:'p15', nome:'Gel Corporal Soft Love 60ml', categoria:'Lubrificantes', qtd:10, preco:32.00, fornecedor:'Loja Online', sku:'LUB-015', img:'img/red_p15.webp' }
];

/* ===== ESTADO ===== */
const state = {
  produtos: LS.get('produtos', seedProducts.slice()),
  clientes: LS.get('clientes', []),
  vendas: LS.get('vendas', [])
};
function persistAll(){ LS.set('produtos', state.produtos); LS.set('clientes', state.clientes); LS.set('vendas', state.vendas); }

/* ===== ELEMENTS / ROUTER ===== */
const view = document.getElementById('view');
const q = document.getElementById('q');
const stats = document.getElementById('stats');
const btnNovo = document.getElementById('btn-novo');
const btnExport = document.getElementById('btn-export');
const navItems = document.querySelectorAll('.nav li');
const titulo = document.getElementById('titulo');

function setActive(page){
  navItems.forEach(li=> li.classList.toggle('active', li.dataset.page === page));
  document.querySelectorAll('[data-page]').forEach(n=> n.classList.toggle('active', n.dataset.page===page));
}

/* ===== ROUTES: DASHBOARD, PRODUTOS, CLIENTES, VENDAS, BACKUP ===== */
function routeDashboard(){
  setActive('dashboard');
  titulo.textContent = 'Dashboard';
  btnNovo.style.display = 'none';
  q.placeholder = 'Buscar...';
  view.innerHTML = `
    <div class="card-grid" style="grid-template-columns:repeat(2,minmax(220px,1fr))">
      <div class="product-card">
        <h3>Produtos cadastrados</h3>
        <p style="font-size:1.4rem;font-weight:700">${state.produtos.length}</p>
      </div>
      <div class="product-card">
        <h3>Clientes cadastrados</h3>
        <p style="font-size:1.4rem;font-weight:700">${state.clientes.length}</p>
      </div>
      <div class="product-card">
        <h3>Vendas registradas</h3>
        <p style="font-size:1.4rem;font-weight:700">${state.vendas.length}</p>
      </div>
      <div class="product-card">
        <h3>Valor em estoque (estimado)</h3>
        <p style="font-size:1.1rem;font-weight:700">${fmtBRL(state.produtos.reduce((s,p)=>s + (p.qtd * p.preco),0))}</p>
      </div>
    </div>
  `;
  stats.textContent = `${state.produtos.length} produtos`;
}

function routeProdutos(){
  setActive('produtos');
  titulo.textContent = 'Produtos';
  btnNovo.style.display = 'inline-block';
  btnNovo.textContent = 'Novo produto';
  q.placeholder = 'Buscar produto por nome, categoria, fornecedor ou SKU...';
  renderProdutos(q.value.trim());
}

function routeClientes(){
  setActive('clientes');
  titulo.textContent = 'Clientes';
  btnNovo.style.display = 'inline-block';
  btnNovo.textContent = 'Novo cliente';
  q.placeholder = 'Buscar cliente por nome...';
  renderClientes(q.value.trim());
}

function routeVendas(){
  setActive('vendas');
  titulo.textContent = 'Vendas';
  btnNovo.style.display = 'inline-block';
  btnNovo.textContent = 'Nova venda';
  q.placeholder = 'Buscar vendas por cliente ou data...';
  renderVendas(q.value.trim());
}

function routeBackup(){
  setActive('backup');
  titulo.textContent = 'Backup / Importar';
  btnNovo.style.display = 'none';
  view.innerHTML = `
    <div class="product-card">
      <h3>Exportar dados</h3>
      <p class="small">Exporte todos os dados (produtos, clientes e vendas) para um arquivo JSON.</p>
      <div style="margin-top:10px"><button class="btn" id="export-all">Exportar JSON</button></div>
    </div>
    <div class="product-card">
      <h3>Importar dados</h3>
      <p class="small">Importe um arquivo JSON válido criado por este sistema.</p>
      <div style="margin-top:10px"><input type="file" id="import-file" accept=".json"></div>
    </div>
  `;
  document.getElementById('export-all').onclick = ()=> {
    const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `loja-backup-${new Date().toISOString().slice(0,10)}.json`; a.click();
  };
  document.getElementById('import-file').onchange = e => {
    const f = e.target.files[0]; if(!f) return;
    const fr = new FileReader();
    fr.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if(Array.isArray(data.produtos)) state.produtos = data.produtos;
        if(Array.isArray(data.clientes)) state.clientes = data.clientes;
        if(Array.isArray(data.vendas)) state.vendas = data.vendas;
        persistAll();
        alert('Importação concluída.');
        routeDashboard();
      } catch(err) { alert('Arquivo inválido.'); }
    };
    fr.readAsText(f);
  };
}

/* NAV HANDLERS */
document.querySelectorAll('.nav li').forEach(li=>{
  li.addEventListener('click', ()=> {
    const page = li.dataset.page;
    if(page === 'dashboard') routeDashboard();
    if(page === 'produtos') routeProdutos();
    if(page === 'clientes') routeClientes();
    if(page === 'vendas') routeVendas();
    if(page === 'backup') routeBackup();
  });
});

/* ===== PRODUTOS: RENDER, CRUD ===== */
function renderProdutos(filter=''){
  const items = state.produtos.filter(p => {
    if(!filter) return true;
    const t = filter.toLowerCase();
    return (p.nome||'').toLowerCase().includes(t) || (p.categoria||'').toLowerCase().includes(t) || (p.fornecedor||'').toLowerCase().includes(t) || (p.sku||'').toLowerCase().includes(t);
  });
  view.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div style="flex:1">
        <input id="filter-prod" class="search" placeholder="Filtrar na lista">
      </div>

    </div>
    <div class="card-grid" id="grid-produtos" style="margin-top:12px"></div>
  `;
  const grid = document.getElementById('grid-produtos');
  grid.innerHTML = items.map(p => `
    <div class="product-card" data-id="${p.id}">
      <img src="${p.img||''}" alt="${escapeHtml(p.nome)}">
      <h3>${escapeHtml(p.nome)}</h3>
      <p class="small">${escapeHtml(p.categoria)} • ${escapeHtml(p.fornecedor||'—')}</p>
      <div class="product-meta">
        <div class="meta-left">
          <div style="font-weight:700">${fmtBRL(p.preco)}</div>
          <div class="small">Qtd: ${p.qtd}</div>
        </div>
        <div class="meta-right">
          <button class="btn ghost" data-ac="edit" data-id="${p.id}">Editar</button>
          <button class="btn" data-ac="del" data-id="${p.id}">Excluir</button>
        </div>
      </div>
    </div>
  `).join('');
  // handlers
  grid.querySelectorAll('[data-ac="edit"]').forEach(b=>b.onclick = ()=> openProduto(b.dataset.id));
  grid.querySelectorAll('[data-ac="del"]').forEach(b=> b.onclick = ()=> {
    if(!confirm('Excluir produto?')) return;
    state.produtos = state.produtos.filter(x=>x.id !== b.dataset.id);
    persistAll(); renderProdutos(filter);
  });
  document.getElementById('novo-prod-btn').onclick = ()=> openProduto();
  document.getElementById('export-produtos').onclick = ()=> {
    let csv = 'Nome,Categoria,Quantidade,Preco,Fornecedor,SKU\n';
    state.produtos.forEach(p => csv += `"${p.nome}","${p.categoria}",${p.qtd},${p.preco},"${p.fornecedor||''}","${p.sku||''}"\n`);
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = 'produtos.csv'; a.click();
  };
  document.getElementById('filter-prod').addEventListener('input', e => renderProdutos(e.target.value.trim()));
  stats.textContent = `${state.produtos.length} produtos • mostrando ${items.length}`;
}
function populateCategorias(selected=''){
  const sel = document.getElementById('p-cat');
  // pegar categorias únicas do estado
  const cats = [...new Set(state.produtos.map(p=>p.categoria).filter(c=>c))].sort();
  sel.innerHTML = '<option value="">— Selecione —</option>' + cats.map(c=>`<option value="${c}" ${c===selected?'selected':''}>${c}</option>`).join('');
}

function openProduto(id){
  editingProdId = id || null;
  if(editingProdId){
    const p = state.produtos.find(x=>x.id===editingProdId);
    if(!p) return alert('Produto não encontrado');
    modalProdTitle.textContent = 'Editar Produto';
    inNome.value = p.nome || '';
    inQtd.value = p.qtd || 0;
    inPreco.value = p.preco || 0;
    inForn.value = p.fornecedor || '';
    inSKU.value = p.sku || '';
    currentImgBase64 = p.img || '';
    if(currentImgBase64){ imgPrev.src = currentImgBase64; imgPrev.style.display = 'block'; } 
    else { imgPrev.style.display = 'none'; }
    populateCategorias(p.categoria); // <-- aqui
  } else {
    modalProdTitle.textContent = 'Novo Produto';
    inNome.value = '';
    inQtd.value = 1;
    inPreco.value = 0;
    inForn.value = '';
    inSKU.value = '';
    inImg.value = '';
    imgPrev.style.display = 'none';
    currentImgBase64 = '';
    populateCategorias(); // <-- aqui
  }
  modalProduto.classList.add('open');
}

/* abrir modal produto (novo/editar) */
const modalProduto = document.getElementById('modalProduto');
const modalProdTitle = document.getElementById('modal-prod-title');
const inNome = document.getElementById('p-nome');
const inCat = document.getElementById('p-cat');
const inQtd = document.getElementById('p-qtd');
const inPreco = document.getElementById('p-preco');
const inForn = document.getElementById('p-forn');
const inSKU = document.getElementById('p-sku');
const inImg = document.getElementById('p-img');
const imgPrev = document.getElementById('p-prev');
const btnSalvarProd = document.getElementById('p-salvar');
const btnCancelProd = document.getElementById('p-cancel');

let editingProdId = null;
let currentImgBase64 = '';

function openProduto(id){
  editingProdId = id || null;
  if(editingProdId){
    const p = state.produtos.find(x=>x.id===editingProdId);
    if(!p) return alert('Produto não encontrado');
    modalProdTitle.textContent = 'Editar Produto';
    inNome.value = p.nome || '';
    inCat.value = p.categoria || '';
    inQtd.value = p.qtd || 0;
    inPreco.value = p.preco || 0;
    inForn.value = p.fornecedor || '';
    inSKU.value = p.sku || '';
    currentImgBase64 = p.img || '';
    if(currentImgBase64){ imgPrev.src = currentImgBase64; imgPrev.style.display = 'block'; } else { imgPrev.style.display = 'none'; }
  } else {
    modalProdTitle.textContent = 'Novo Produto';
    inNome.value = '';
    inCat.value = '';
    inQtd.value = 1;
    inPreco.value = 0;
    inForn.value = '';
    inSKU.value = '';
    inImg.value = '';
    imgPrev.style.display = 'none';
    currentImgBase64 = '';
  }
  modalProduto.classList.add('open');
}

inImg.addEventListener('change', ()=> {
  const file = inImg.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => { currentImgBase64 = e.target.result; imgPrev.src = currentImgBase64; imgPrev.style.display = 'block'; };
  reader.readAsDataURL(file);
});

btnSalvarProd.onclick = ()=> {
  const nome = inNome.value.trim();
  if(!nome) return alert('Informe o nome do produto.');
  const obj = {
    id: editingProdId || uid(),
    nome,
    categoria: inCat.value.trim(),
    qtd: Number(inQtd.value) || 0,
    preco: Number(inPreco.value) || 0,
    fornecedor: inForn.value.trim(),
    sku: inSKU.value.trim(),
    img: currentImgBase64 || sampleImg('Sem imagem','#cccccc')
  };
  if(editingProdId){
    const idx = state.produtos.findIndex(x=>x.id===editingProdId);
    if(idx>=0) state.produtos[idx] = obj;
  } else {
    state.produtos.push(obj);
  }
  persistAll();
  modalProduto.classList.remove('open');
  routeProdutos();
};
btnCancelProd.onclick = ()=> modalProduto.classList.remove('open');

/* ===== CLIENTES: CRUD ===== */
function renderClientes(filter=''){
  const items = state.clientes.filter(c => {
    if(!filter) return true;
    return (c.nome||'').toLowerCase().includes(filter.toLowerCase());
  });
  view.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div style="flex:1">
        <input id="filter-cli" class="search" placeholder="Filtrar clientes">
      </div>

    </div>
    <div style="margin-top:12px">
      ${items.length ? `<table><thead><tr><th>Nome</th><th>Telefone</th><th>Endereço</th><th>Ações</th></tr></thead><tbody>${items.map(c=>`<tr data-id="${c.id}"><td>${escapeHtml(c.nome)}</td><td>${escapeHtml(c.telefone||'')}</td><td>${escapeHtml(c.endereco||'')}</td><td><button class="btn ghost" data-ac="ver" data-id="${c.id}">Ver</button> <button class="btn ghost" data-ac="edit" data-id="${c.id}">Editar</button> <button class="btn" data-ac="del" data-id="${c.id}">Excluir</button></td></tr>`).join('')}</tbody></table>` : '<p class="muted">Nenhum cliente cadastrado.</p>'}
    </div>
  `;
  document.getElementById('novo-cli-btn').onclick = ()=> openCliente();
  document.getElementById('filter-cli').addEventListener('input', e => renderClientes(e.target.value.trim()));
  document.querySelectorAll('button[data-ac="ver"]').forEach(b => b.onclick = ()=> {
    const c = state.clientes.find(x=>x.id === b.dataset.id);
    if(!c) return;
    alert(`Nome: ${c.nome}\nTelefone: ${c.telefone||'—'}\nEndereço: ${c.endereco||'—'}`);
  });
  document.querySelectorAll('button[data-ac="edit"]').forEach(b => b.onclick = ()=> openCliente(b.dataset.id));
  document.querySelectorAll('button[data-ac="del"]').forEach(b => b.onclick = ()=> {
    if(!confirm('Excluir cliente?')) return;
    state.clientes = state.clientes.filter(x=>x.id !== b.dataset.id);
    persistAll(); renderClientes(filter);
  });
  stats.textContent = `${state.clientes.length} clientes • mostrando ${items.length}`;
}

/* modal cliente */
const modalCliente = document.getElementById('modalCliente');
const mcTitle = document.getElementById('modal-cli-title');
const inCNome = document.getElementById('c-nome');
const inCTel = document.getElementById('c-tel');
const inCEnd = document.getElementById('c-end');
const btnSalvarCli = document.getElementById('c-salvar');
const btnCancelCli = document.getElementById('c-cancel');
let editingCliId = null;

function openCliente(id){
  editingCliId = id || null;
  if(editingCliId){
    const c = state.clientes.find(x=>x.id === editingCliId);
    if(!c) return alert('Cliente não encontrado');
    mcTitle.textContent = 'Editar Cliente';
    inCNome.value = c.nome || '';
    inCTel.value = c.telefone || '';
    inCEnd.value = c.endereco || '';
  } else {
    mcTitle.textContent = 'Novo Cliente';
    inCNome.value = ''; inCTel.value = ''; inCEnd.value = '';
  }
  modalCliente.classList.add('open');
}
btnSalvarCli.onclick = ()=> {
  const nome = inCNome.value.trim();
  if(!nome) return alert('Informe o nome do cliente.');
  const obj = { id: editingCliId || uid(), nome, telefone: inCTel.value.trim(), endereco: inCEnd.value.trim(), dataRegistro: new Date().toISOString() };
  if(editingCliId){
    const idx = state.clientes.findIndex(x=>x.id===editingCliId);
    if(idx>=0) state.clientes[idx] = obj;
  } else state.clientes.push(obj);
  persistAll();
  modalCliente.classList.remove('open');
  routeClientes();
};
btnCancelCli.onclick = ()=> modalCliente.classList.remove('open');

/* ===== VENDAS: fluxo simples de venda ===== */
const modalVenda = document.getElementById('modalVenda');
const selVCliente = document.getElementById('v-cliente');
const selVProduto = document.getElementById('v-produto');
const inVQtd = document.getElementById('v-qtd');
const btnVAdd = document.getElementById('v-add-item');
const tbodyV = document.querySelector('#v-itens-table tbody');
const lblVTotal = document.getElementById('v-total');
const inVDesconto = document.getElementById('v-desconto');
const btnVConfirm = document.getElementById('v-confirmar');
const btnVCancel = document.getElementById('v-cancel');
const selVPag = document.getElementById('v-pagamento');

let carrinho = [];

function renderVendas(filter=''){
  // list vendas
  const items = state.vendas.slice().reverse().filter(v=>{
    if(!filter) return true;
    const t = filter.toLowerCase();
    const cliente = state.clientes.find(c=>c.id===v.clienteId)?.nome || '';
    return cliente.toLowerCase().includes(t) || v.dataISO.toLowerCase().includes(t);
  });
  view.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div style="flex:1"><input id="filter-v" class="search" placeholder="Filtrar vendas por cliente ou data"></div>
    </div>
    <div style="margin-top:12px">
      ${items.length ? `<table><thead><tr><th>Data</th><th>Cliente</th><th>Total</th><th>Itens</th></tr></thead><tbody>${items.map(v=>`<tr><td>${new Date(v.dataISO).toLocaleString()}</td><td>${state.clientes.find(c=>c.id===v.clienteId)?.nome||'—'}</td><td>${fmtBRL(v.total)}</td><td>${v.itens.map(i=>`${i.qtd}× ${escapeHtml(i.nome)}`).join(', ')}</td></tr>`).join('')}</tbody></table>` : '<p class="muted">Nenhuma venda registrada.</p>'}
    </div>
  `;
  document.getElementById('nova-venda-btn').onclick = ()=> openVenda();
  document.getElementById('filter-v').addEventListener('input', e=> renderVendas(e.target.value.trim()));
  stats.textContent = `${state.vendas.length} vendas • mostrando ${items.length}`;
}

function openVenda(){
  // preencher selects
  selVCliente.innerHTML = `<option value="">— Cliente (opcional) —</option>` + state.clientes.map(c=>`<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join('');
  selVProduto.innerHTML = state.produtos.map(p=>`<option value="${p.id}">${escapeHtml(p.nome)} — ${p.qtd} un. — ${fmtBRL(p.preco)}</option>`).join('');
  inVQtd.value = 1;
  carrinho = [];
  renderCarrinho();
  inVDesconto.value = 0;
  modalVenda.classList.add('open');
}

btnVAdd.onclick = ()=> {
  const pid = selVProduto.value;
  const qtd = Math.max(1, Number(inVQtd.value) || 1);
  const p = state.produtos.find(x=>x.id === pid);
  if(!p) return alert('Selecione um produto.');
  if(p.qtd < qtd) return alert('Estoque insuficiente.');
  const existing = carrinho.find(i=>i.produtoId === pid);
  if(existing) existing.qtd += qtd; else carrinho.push({ produtoId: pid, nome: p.nome, qtd, preco: p.preco });
  renderCarrinho();
};

function renderCarrinho(){
  tbodyV.innerHTML = carrinho.map((it, idx)=>`<tr data-idx="${idx}"><td>${escapeHtml(it.nome)}</td><td>${it.qtd}</td><td>${fmtBRL(it.preco)}</td><td>${fmtBRL(it.qtd * it.preco)}</td><td><button class="btn ghost" data-rem="${idx}">Rem</button></td></tr>`).join('');
  tbodyV.querySelectorAll('[data-rem]').forEach(b=> b.onclick = ()=> { carrinho.splice(Number(b.dataset.rem),1); renderCarrinho(); });
  const sub = carrinho.reduce((s,i)=>s + i.qtd * i.preco, 0);
  const desconto = Number(inVDesconto.value) || 0;
  const total = Math.max(0, sub - desconto);
  lblVTotal.textContent = `Total: ${fmtBRL(total)}`;
}

btnVConfirm.onclick = ()=> {
  if(carrinho.length === 0) return alert('Adicione ao menos um item.');
  // verificar estoque
  for(const it of carrinho){
    const prod = state.produtos.find(p=>p.id === it.produtoId);
    if(!prod) return alert(`Produto ${it.nome} não encontrado.`);
    if(prod.qtd < it.qtd) return alert(`Estoque insuficiente para ${it.nome}.`);
  }
  const sub = carrinho.reduce((s,i)=>s + i.qtd * i.preco, 0);
  const desconto = Number(inVDesconto.value) || 0;
  const total = Math.max(0, sub - desconto);
  const clienteId = selVCliente.value || null;
  const forma = selVPag.value;
  const venda = { id: uid(), dataISO: new Date().toISOString(), clienteId, itens: JSON.parse(JSON.stringify(carrinho)), total, forma };
  // aplicar saída de estoque
  carrinho.forEach(it => {
    const prod = state.produtos.find(p=>p.id === it.produtoId);
    prod.qtd = prod.qtd - it.qtd;
  });
  state.vendas.push(venda);
  persistAll();
  alert('Venda registrada!');
  modalVenda.classList.remove('open');
  routeVendas();
};

btnVCancel.onclick = ()=> modalVenda.classList.remove('open');
inVDesconto.addEventListener('input', renderCarrinho);

/* ===== UTIL: ESCAPE HTML ===== */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ===== BUSCA GLOBAL (botões e campo q) ===== */
q.addEventListener('input', ()=> {
  const text = q.value.trim();
  const active = document.querySelector('.nav li.active')?.dataset.page || 'dashboard';
  if(active === 'produtos') renderProdutos(text);
  if(active === 'clientes') renderClientes(text);
  if(active === 'vendas') renderVendas(text);
});

/* botão novo contextual */
btnNovo.addEventListener('click', ()=> {
  const active = document.querySelector('.nav li.active')?.dataset.page || 'dashboard';
  if(active === 'produtos') openProduto();
  if(active === 'clientes') openCliente();
  if(active === 'vendas') openVenda();
});

/* export JSON rápido do topo */
btnExport.addEventListener('click', ()=> {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'}));
  a.download = `loja-dados-${new Date().toISOString().slice(0,10)}.json`; a.click();
});

/* inicial route */
routeDashboard();

/* quick nav header (click on sidebar items already wired) */
document.querySelectorAll('.nav li').forEach(li => li.addEventListener('click', ()=> {
  const p = li.dataset.page;
  if(p === 'dashboard') routeDashboard();
  if(p === 'produtos') routeProdutos();
  if(p === 'clientes') routeClientes();
  if(p === 'vendas') routeVendas();
  if(p === 'backup') routeBackup();
}));

</script>
</body>
</html>

